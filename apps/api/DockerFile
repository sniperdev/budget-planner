# --- builder ---
FROM node:20-alpine AS builder
WORKDIR /repo

RUN corepack enable

# kopiujemy tylko pliki potrzebne do instalacji zależności
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY apps/api/package.json apps/api/package.json
COPY packages packages

RUN pnpm install --frozen-lockfile

# kopiujemy kod API
COPY apps/api apps/api

# build tylko API
RUN pnpm -w turbo run build --filter=api...

# --- runtime ---
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# Nest zwykle builduje do dist/
COPY --from=builder /repo/apps/api/dist ./dist
COPY --from=builder /repo/apps/api/package.json ./package.json

# jeśli API potrzebuje runtime deps, możesz tu doinstalować,
# ale w template często Nest jest bundlowany tak, że wystarczy dist + node.
# Jeśli okaże się, że brakuje node_modules -> dopracujemy (zależnie od template).

EXPOSE 3000
CMD ["node", "dist/main.js"]